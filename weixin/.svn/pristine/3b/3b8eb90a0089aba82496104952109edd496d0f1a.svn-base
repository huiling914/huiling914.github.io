// pages/homepage/homepage.js
const app = getApp()
const util = require('../../utils/util.js')
const getlist = require('../../utils/list.js')
const imageURL = app.globalData.imageURL
const imgURL = '../../images/homepage'
const categoryUrl = '/mall/admin/category/list'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    picList: [{
        id: '1',
        src: imageURL + '/banner4.png'
      },
      {
        id: '2',
        src: imageURL + '/banner1.png'
      },
      {
        id: '3',
        src: imageURL + '/banner2.png'
      }
    ],
    itemList: [],
    typeList: [],
    schoolList: [],
    isIphone5: false
  },

  //根据类目信息获取首页展示信息
  getShowInfo: function(i, type) {
    const getUrl = '/mall/admin/school/list'
    getlist.getList(getUrl, type, 1, this, 'typeList[' + i + '].schoolList', 4)
  },

  //获取类目信息和核心展示信息
  getInfo: function(data) {
    let itemList = [],
      typeList = [],
      item = {}
    for (var i = 0, len = data.length; i < len; i++) {
      item = {}
      item['src'] = util.jointUrl(data[i]['iconUrl'])
      item['text'] = data[i]['name']
      item['type'] = i == len - 1 ? 0 : data[i]['id']
      itemList.push(item)
      if (i < len - 1) {
        typeList.push(item)
        //获取该类目的展示信息
        this.getShowInfo(i, data[i]['id'])
      }
    }
    this.setData({
      itemList: itemList,
      typeList: typeList
    })
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    //请求学校类目数据
    app.wxRequest(categoryUrl, {
      type: 1,
      limit: 20
    }, 'get').then(data => {
      const res = data.data
      if (res['errno'] == 0) {
        //请求成功，封装数据
        this.getInfo(res['data']['items'])
      } else {
        util.errorTip(res.errmsg)
      }
    })
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function() {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function() {

  },
  goToSchool: function(e) {
    const that = this
    const type = e.currentTarget.dataset.type
    app.globalData.schoolType = type
    wx.switchTab({
      url: '/pages/school/school',
      success: function(e) {
        var page = getCurrentPages().pop();
        if (page == undefined || page == null) return;
        page.onLoad();
      }
    })
  },
  schoolDetails: function(e) {
    const that = this
    const id = e.currentTarget.dataset.id
    wx.navigateTo({
      url: '/pages/school/details/details?id=' + id,
    })
  },
  swiperChange: function(e) {
    this.setData({
      currentTab: e.detail.current
    })
  },
  onShareAppMessage: function () {
    let that = this;
    return {
      title: '乐宝教育365', // 转发后 所显示的title
      path: '/pages/loading/loading'
    }
  }
})