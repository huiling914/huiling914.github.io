// pages/store/store.js
const app = getApp()
const util = require('../../utils/util.js')
const getlist = require('../../utils/list.js')
const imageURL = app.globalData.imageURL
const getUrl = '/mall/admin/brand/list'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    currentType: 0,
    contentHeight: '',
    isIphone5: '',
    navbarList: [],
    hotPic: imageURL + '/shop-banner.png',
  },

  //获取类目信息和核心展示信息
  getCategory: function(data) {
    let navbarList = [],
      item = {},
      currentType = data[0]['id']
    //请求获取第一组数据展示
    getlist.getGoodsList(getUrl, currentType, 1, this, 'schoolList')
    for (var i = 0, len = data.length; i < len; i++) {
      item = {}
      item['name'] = data[i]['name']
      item['type'] = data[i]['id']
      navbarList.push(item)
    }
    this.setData({
      navbarList: navbarList,
      currentType: currentType
    })
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    const that = this
    let contentHeight = 0
    if (app.globalData.isIphone5) {
      contentHeight = app.globalData.sysH - 104
    } else {
      contentHeight = app.globalData.sysH - 100
    }
    that.setData({
      isIphone5: app.globalData.isIphone5,
      contentHeight: contentHeight
    })
    //获取类目信息
    app.wxRequest('/mall/admin/category/list', {
      type: 0,
      limit: 20
    }, 'get').then(data => {
      const res = data.data
      if (res['errno'] == 0) {
        //请求成功，封装数据
        this.getCategory(res['data']['items'])
      } else {
        util.errorTip(res.errmsg)
      }
    })

  },

  changeType: function(e) {
    const that = this
    const type = e.currentTarget.dataset.type
    that.setData({
      currentType: type
    })
    getlist.getGoodsList(getUrl, type, 1, that, 'schoolList')
  },
  search: function() {
    wx.navigateTo({
      url: '/pages/search/search?page=store',
    })
  },
  storeDetails: function(e) {
    const that = this
    const id = e.currentTarget.dataset.id
    console.log('id', e)
    wx.navigateTo({
      url: '/pages/store/details/details?id=' + id,
    })
  },
  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function() {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function() {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function() {
    var self = this;
    setTimeout(() => {
      // 模拟请求数据，并渲染
      var arr = self.data.dataList,
        max = Math.max(...arr);
      for (var i = max + 1; i <= max + 3; ++i) {
        arr.unshift(i);
      }
      self.setData({
        dataList: arr
      });
      // 数据成功后，停止下拉刷新
      wx.stopPullDownRefresh();
    }, 1000);
  },
  onReachBottom: function() {
    var arr = this.data.dataList,
      max = Math.max(...arr);
    if (this.data.count < 3) {
      for (var i = max + 1; i <= max + 5; ++i) {
        arr.push(i);
      }
      this.setData({
        dataList: arr,
        count: ++this.data.count
      });
    } else {
      util.errorTip('没有更多数据了！')
    }
  },
  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function() {

  },

  onShareAppMessage: function () {
    let that = this;
    return {
      title: '乐宝教育365', // 转发后 所显示的title
      path: '/pages/loading/loading'
    }
  }
})