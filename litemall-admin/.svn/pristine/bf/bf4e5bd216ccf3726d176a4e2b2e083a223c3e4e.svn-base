<template>
	<div class="app-container">
		<!--查询和其他操作-->
		<div class="filter-container">
			<el-select v-model="listQuery.audit" class="filter-item" style="width:200px" placeholder="请选择审核状态">
				<el-option v-for="(value,index) in audit" :key="index" :label="value" :value="index"/>
			</el-select>
			<el-button type="primary" class="filter-item" icon="el-icon-search" @click="handleFilter">查找</el-button>
			<el-button  class="filter-item" type="primary" :loading="downloadLoading"
                       icon="el-icon-edit" @click="handleDownLoad">导出
            </el-button>
		</div>
		<!--查询结果-->
		<div style="height: calc(100% - 155px);overflow: hidden">
            <el-table v-loading="listLoading" :data="list" size="small" element-loading-text="正在查询中。。。" border fit highlight-current-row height="100%">
            	<el-table-column align="center" label="用户ID" prop="userId"/>
            	<el-table-column align="center" label="审核状态" prop="status">
            		<template slot-scope="scope">
            			<el-tag>{{audit[scope.row.status]}}</el-tag>
            		</template>
            	</el-table-column>
            	<el-table-column align="center" label="视频详情" prop="description"/>
            	<el-table-column align="center" label="申请发布时间" prop="addTime"/>
            	<el-table-column align="center" label="操作"  class-name="small-padding fixed-width">
                    <template slot-scope="scope">
                        <!-- <el-button type="primary" size="mini" @click="">详情</el-button> -->
                        <el-button type="primary" size="mini" @click="handleAudit(scope.row)">审核</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <pagination v-show="total>0" :total="total" :page.sync="listQuery.page" :limit.sync="listQuery.limit"
                    @pagination="getList"/>
        <!--详情对话框-->
        <el-dialog title="'审核'" :close-on-click-modal="false" :visible.sync="dialogFormVisible" >
         <el-form ref="dataForm" :rules="rules" :model="dataForm" status-icon label-position="left"  label-width="18%" style="width: 90%; margin-left:50px;">
        	<el-form-item label="用户ID" prop="userId">
                    <span>{{dataForm.userId}}</span>
            </el-form-item>
            <el-form-item label="视频描述" prop="description">
            	<span>{{dataForm.description}}</span>
            </el-form-item>
            <el-form-item label="视频" prop="url">
            	<video  id="myvideo" :src="dataForm.url"   :muted="muteStatus" :autoplay="playStatus"  height="250" width="400" controls>
                    your browser does not support the video tag
                </video>
            </el-form-item>
            <el-form-item label="审核状态" prop="status"> 
            	<span><el-tag>{{audit[dataForm.status]}}</el-tag></span>
            </el-form-item>
            <el-form-item label="申请发布时间" prop="addTime">
            	<span>{{dataForm.addTime}}</span>
            </el-form-item>
            <el-form-item v-if="dataForm.status!=0" label="审核人员" prop="auditAdminId">
            	<span>{{dataForm.auditAdminId}}</span>
            </el-form-item>
            <el-form-item v-if="dataForm.status!=0" label="审核意见" prop="auditFeedback">
            	<span>{{dataForm.auditFeedback}}</span>
            </el-form-item>
            <el-form-item v-else="dataForm.status==0" label="审核意见" prop="auditFeedback">
            	<el-input type="textarea" :row="3" v-model="dataForm.auditFeedback" placeholder="请输入审核意见"/>
            </el-form-item>
            <el-form-item  v-if="dataForm.status==0" label="是否通过" prop="result">
            	<el-select v-model="dataForm.result" placeholder="是否通过">
            		<el-option label="通过" value="0"/>
            		<el-option label="拒绝" value="1"/>
            	</el-select>
            </el-form-item>
         </el-form>
         <div slot="footer" class="dialog-footer">
                <el-button @click="dialogFormVisible = false">取消</el-button>
                <el-button :loading="auditLoading" v-if="dataForm.status==0" type="primary" @click="auditVideo">审核</el-button>
                <el-button v-else type="primary" @click="dialogFormVisible = false">确定</el-button>
          </div>

        </el-dialog>
	</div>
</template>
<script>
	import Pagination from '@/components/Pagination'
	import {listUserVideo,auditVideo} from '@/api/video'
	export default{
		name:'userVideo',
		components:{Pagination},
		data(){
			return{
				listQuery:{
					audit_result:undefined,
					page:1,
					limit:20,
					sort:'add_time',
					order:'desc'
				},
				downQuery:{
					audit_result:undefined,
					page:1,
					limit:-1,
					sort:'add_time',
					order:'desc'
				},
				list:[],
				downloadList:[],
				listLoading:false,
				downloadLoading:false,
				auditLoading:false,//审核加载
				total:0,
				dialogFormVisible:false,
				dialogStatus: '',
				audit:['待审核','通过','不通过'],
				videoUrl:undefined,
				videoDialogVisible:false,
				playStatus:false,
                muteStatus:'',
				dataForm:{
					userId:undefined,
					description:undefined,
					url:undefined,
					status:undefined,
					addTime:undefined,
					auditAdminId:undefined,
					auditFeedback:undefined,
					result:undefined
				},
				auditLoading:false,
				rules:{
					result:[{required: true, message: '请选择是否通过', trigger: 'blur'}]
				},
				auditInfo:{
					userVideoResIds:[],
					feedback:undefined,
					result:undefined
				}

			}
		},
		created(){
			this.getList()
		},
		methods:{
			getList(){
				this.listLoading=true
				listUserVideo(this.listQuery).then((res)=>{
					this.list=res.data.data.items
					this.total=res.data.data.total
					this.listLoading=false
				}).catch((err)=>{
					this.list=[]
					this.total=0
					this.listLoading=false
				})
			},
			getDownList(){
				listUserVideo(this.downQuery).then((res)=>{
					this.downloadList=res.data.data.items
					import('@/vendor/Export2Excel').then(excel => {
                    const tHeader = [
                        '视频ID',
                        '用户ID',
                        '视频描述',
                        '视频链接',
                        '申请发布时间',
                        '审核状态',
                        '审核人员',
                        '审核意见'
                    ]
                    const filterVal = ['id', 'userId', 'description', 'url', 'addTime','status','auditAdminId','auditFeedback']
                    excel.export_json_to_excel2(
                        tHeader,
                        this.downloadList,
                        filterVal,
                        '用户视频'
                    )
                    this.downloadLoading = false
                })
					//console.log(this.downloadList)
					
				}).catch((err)=>{
					this.downloadList=[]
					
				})
			},
			handleFilter(){
				this.listQuery.page=1
				this.getList()
			},
			handleDownLoad(){
				if(!this.downloadLoading){
					this.downloadLoading=true
					this.downQuery=this.listQuery
				    this.downQuery.limit=-1
				    this.getDownList()
				    //console.log(this.downloadList)
				    
				}
				

			},
			handleAudit(row){
				this.dialogFormVisible=true
				this.dataForm = Object.assign({}, row)
			},
			resetAuditInfo(){
				this.auditInfo={
					userVideoResIds:[],
					feedback:undefined,
					result:undefined
				}
			},
			auditVideo(){
				this.resetAuditInfo()
				this.$refs.dataForm.validate(valid=>{
					if(valid && !this.auditLoading){
						this.auditLoading=true
						this.auditInfo.userVideoResIds.push(this.dataForm.id)
						this.auditInfo.feedback=this.dataForm.auditFeedback
						this.auditInfo.result=this.dataForm.result
						auditVideo(this.auditInfo).then((res)=>{
							this.auditLoading=false
							this.listQuery.page=1
							this.getList()
							this.dialogFormVisible=false
							this.$notify.success({
								title: '成功',
                                message: '审核成功'
                            })
						}).catch((err)=>{
							this.auditLoading=false
							//this.getList()
							this.dialogFormVisible=false
							this.$notify.error({
								title: '失败',
                                message: '审核失败'
                            })
						})
					}else{
						return false
					}
				})
			}
		}
	}
</script>